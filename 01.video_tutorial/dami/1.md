

 
 Pagerduty 的年头不短了，在企业中 尤其是外企 出镜率⾮常⾼
 虽然是收费监控，但是费对于个企业来说很便宜 甚⾄对于
 个⼈户来说其实也不算⾼

 Pagerduty 拥有 短信，电话，邮件 所有的报警机制

 Pagerduty 还有⾮常实的必要的 [运维值班管理制度]{.underline} 和
 报警升级等等 扩展功能 往后我们会陆续介绍到

 Pagerduty的优点⾮常多，使率⾮常⾼（外企⼏乎清⾊的使，国内企业很多也在使）
 但是有优点就肯定也有不⾜

 Pagerduty有⼏个⼩问题 需要提⾼

  对中⽂的⽀持不好 或者说⼏乎不⽀持 （指的是 语⾳播报⽅⾯ ）=\
 那咱们为啥不多提⾼下⾃⼰的 英⽂能？\^\_\^

  站点主要在美国和海外 ⽹速有时候不太给 =\ 可以⾛代理的⽅式
 加快速度 其他的问题 基本上没有了

 **7 最后 我们来谈谈 Prometheus相⽐其他⽼款监控的
 不可被替代的巨优势，以及些不⾜有待提⾼的 地⽅**

  监控数据的精细程度 绝对的第 可以精确到 1～5秒的采集精度 4 5分钟
 理想的状态 我们来算算 采集精度 （存储 性能）

  集群部署的速度 监控脚本的制作 （指的是熟练之后） ⾮常快速
 缩短监控的搭建时间成本

  周边插件很丰富 exporter pushgateway 多数都不需要⾃⼰开发了

  本基于数学计算模型，量的实函数
 可以实现很复杂规则的业务逻辑监控（例如QPS的曲线 弯曲 凸起 下跌的
 ⽐例等等模糊概念）

  可以嵌⼊很多开源具的内部 进⾏监控 数据更准时
 更可信（其他监控很难做到这点）

 
 本是开源的，更新速度快，bug修复快。⽀持N多种语⾔做本和插件的次开发

  图形很⾼上 很美观 ⽼板特别喜欢看这种业务图
 （主要是指跟Grafana的结合）

 些不⾜的地⽅

  因其数据采集的精度 如果集群数量太，那么单点的监控有性能瓶颈
 ⽬前尚不⽀持集群 只能

 workaround

  学习成本太，尤其是其独有的数学命令⾏（⾮常强的同时
 又极其难学《=⾃学的情况下），
 中⽂资料极少，本的各种数学模型的概念很复杂（如果没⼈教
 ⾃⼰点点学英⽂官⽹ 得 1-3 个

 ⽉⼊门）

  对磁盘资源也是耗费的较，这个具体要看 监控的集群量 和 监控项的多少
 和保存时间的长短

  本的使 需要使者的数学不能太差 要有定的数学头脑（这个说真的
 我觉得才是最难克服 的）

  再难也不担⼼ 有⽶ ⽆难事！

 **8 序章结束 ， 之后跟着⽶⽼师
 起来学习这款⾼上的prometheus监控 起做监控的明⽇之星吧**

 第一讲 企业级运维监控理理论基础

 --- 第一讲内容

  监控在企业中的重要性

  监控在运维作中的⽐重

  数据采集的重要性

  运维监控种类的分类

  监控做不好的各种后果

  监控做好了的各种好梦

 1 监控在企业中的重要性

 追溯到监控不发达的时代，那时候 基本属于个
 出⾏基本靠⾛，安全基本靠狗🐶

 记得在2006年 我刚刚开始做运维的时候，哪有什么⾃动化监控的概念

 ⾄少都得是⼈盯着（不⾄于靠狗🐶 。。。。） 服务器概是2，3台的样⼦
 记不清楚了

 所有服务器 都接着单独的显⽰器运⾏着

 每天上班 第件事 就是⾛进去巡视下，看看各种软件打印出来的输出信息
 是否有报错 如果有 就拿个

 Excel 记录下，再发邮件给⽼板。。。。。 想起来都觉得 臊得慌

 不过其实在那个年代 也是没有办法
 运维本就很原始，各种运维技术都处于拓荒的阶段

 如今的企业中 动不动运维就要负责 成百上千
 甚⾄上万台机器（之前在家公司 维护过近30000+服务器 虚拟机+物理机
 横跨美国7个州）

 没有⾼上的⽅法 是绝对⽀撑不起来这种规模的 监控的

 服务器随时随地 都有可能出故障，出问题，需要被监控住

 不管是虚拟机还是物理机
 还是各种软件，各种线上产品，操作系统，⽹络设备，办公环境，业务数据，

 户体验

 说句夸张点的话： 现在连员上个班
 打卡机都得弄个监控，打卡机⾃⼰本可能会坏，打卡记录 还得被

 HR监控

 各种监控啊～～～～ 都是运维的事啊～～～

 很多情况下 企业对某种类型的监控
 需要⾮常的敏感(采集的精度)，例如户正常访问 这种业务级别的监 控

 旦出现了问题 需要在妙极的时间
 ⽴刻知道，（时间=钱）不然就是毁灭性的灾难和损失 由其是针对哪
 些规模的企业

 所以说 监控对于企业的重要性 不⾔⽽喻了

 **2 监控在运维作中的⽐重**

 基础运维（系列第阶段）线 主要扮演着 个处理⽇常任务，及时救⽕
 这样的⾓⾊

 ⽽监控的搭建 和 数据采集的作 很多时候 需要依赖于
 运维开发的协助（开发 创新）

 在⽶运维课堂
 第阶段前三节课中，有详细介绍各种运维职位的职责（没有看的同学
 感兴趣的话 可以 去回顾下课程）

 不管是哪种运维（哪怕你是运维架构师 运维专家）在紧急的时候
 ⼈⼈都要扮演起 救⽕英雄的⾓⾊

 ⽽救⽕ 指的是 及时的发现和解决线上出现的各种故障 问题

 那么为了要做到 及时的发现问题，那么个好的完善的监控系统
 就很⾃然的作为 运维作中的第优先 级任务

 个最理想的 完整的 监控体系的搭建 有赖于如下这么⼏个⽅⾯的作
 以及流程

 值得说的是，在部分的企业中，都⽆法做到
 如上图的如此完善的监控创作体制 很多时候 有些其实很重要的部分
 确被当成可有可⽆ 带⽽过

 我本⼈觉得 ⾮常不可取的同时 也感到⽆奈

 因为很多时候 客观因素的量太强了。。。。。事事完美⽆缺 难啊！

 （但是我们作为个运维架构师 依然要有追求完美的信念 ）
 接下来我们分别解释下 监控流程中的 这些部分的内容

 **1 监控系统设计（架构师）：**

 ⾸当其冲 就是压在运维架构师的肩膀上的任务
 设计如果都设计不好，那么后⾯的事⼉也是⽩⼲ 设计部分包括如下的内容：

  评估系统的业务流程 业务种类 架构体系
 各个企业的产品不同，业务⽅向不同，程序代码不同，系统架构更不同
 对于各个地⽅的细节 都需要有定程度的认知 才可以开起设计的源头

  分类出所需的监控项种类

 般可分为 ： 业务级别监控 / 系统级别监控 / ⽹络监控 / 程序代码监控/
 ⽇志监控 / 户⾏为分析监控/ 其 他种类监控

 的分类 还有更多的细⼩分类 这给出⼏个例⼦

 例如：

  业务监控 可以包含 户访问QPS，DAU⽇活，访问状态（http code），
 业务接⼜(登陆，注
 册，聊天，上传，留⾔，短信，搜索)，产品转化率，充值额度，户投诉
 等等这些很宏观的概 念（上层）

  系统监控 主要是跟操作系统相关的 基本监控项 CPU/ 内存 / 硬盘 / IO /
 TCP链接 / 流量 等等

 (Nagios - plugins, prometheus)

  ⽹络监控 （IDC）对⽹络状态的监控（交换机，路由器，防⽕墙，VPN）
 互联⽹公司必不可 少 但是很多时候又被忽略
 例如：内⽹之间（物理内⽹，逻辑内⽹ 可区 创建虚拟机 内⽹IP ） 外⽹
 丢包率 延迟 等等

  ⽇志监控 监控中的重头戏（Splunk,ELK），往往单独设计和搭建，
 全部种类的⽇志都有需要采 集 (syslog, soft, ⽹络设备，户⾏为)

  程序监控 般需要和开发⼈员配合，程序中嵌⼊各种接⼜ 直接获取数据
 或者特质的⽇志格式

  监控技术的⽅案/软件选取（主观因素） 各种监控软件层出不穷，开源的
 商业的 ⾃⾏开发的 ⼏百种的可选⽅案 架构师凭借些因素 开始选材.
 针对企业的架构特点，⼩，种类，⼈员多少 等等 选取合适的技术⽅案

  监控体系的⼈员安排 运维团队的任务划分，责任到⼈，分块进⾏
 开发团队的配合⼈员选取，很多监控涉及的作 都需要跟开发⼈员配合
 才可以进⾏

 **2 监控系统的搭建**

  单点服务端的搭建(prometheus)

  单点客户端的部署

  单点客户端服务器测试

  采集程序单点部署

  采集程序批量部署

  监控服务端HA / cloud (⾃⼰定制)

  监控数据图形化搭建（Grafana）

  报警系统测试(Pagerduty)

  报警规则测试

  监控+报警联合测试

  正式上线监控

 3 **数据采集的编写**

  可选脚本作为数据采集途径

 例如： shell / python / awk / lua （Nginx 安全控制，功能分类）/ php /
 perl/ go 等等

 shell ： 运维的⼊门脚本，任何和性能/后台/界⾯⽆关的逻辑
 都可以实现最快速的开发

 （shell 是在运维领域 开发速度最快 难度最低的）

 python: 各种扩展功能 扩展库 功能丰富
 ，伴随各种程序的展⽰+开发框架（如django）等 可以
 实现快速的中⾼档次的平台逻辑开发. ⽬前在运维届
 除去shell这个所有⼈必须会的脚本之外，⽕爆程度就 属python了

 awk: 本是个实命令 也是门庞的编程语⾔. 结合shell脚本 或者独⽴
 都可以使。 在⽂本和标准输出处理上 有很的优势

 lua: 多于nginx的模块结合 是⽐较新型的个语⾔
 php：⽼牌⼦的开发语⾔，在型互联⽹开发中，⽬前有退潮的趋势
 （PHP语⾔，php-fpm）不过在运维 中 具开发还是很依赖PHP

 perl: 传说中 对⽂本处理最快的脚本语⾔ （但是代码可读性不强）

 go: 新型的语⾔ ⽬前在开发和运维中 炒的很热 资也⾼ C语⾔
 在各种后端服务逻辑的编写上 开发速度 快 成⾏早

 作为监控数据采集， 我们⾸推 shell + python ， 如果说
 数据采集选取的模式 对性能/后台/界⾯ 不依赖， 那么shell速度最快
 成本最低（公司往往喜欢快的）

  数据采集的形式分类

 ） 次性采集： 例如我们使⽐较简单的 shell ./monitor.sh (ps -ef \|
 grep, netstats -an \| wc )+ crontab的形式 按10秒 / 30秒 / 分钟
 这样的频率去 单词采集

 这种形式的优点=》 次性采集的模式 稳定性较好 不容易出现各种错误
 和性能瓶颈，且开发逻辑简单 实 现快速

 这种形式的缺点= 次性采集 对于有些采集项⽬ 实现起来不够智能
 也不够到位 例如 ⽇志的实时采集

 （使次性采集 ⽇志⽂件 200/5xx diff grep 也可以实现 但是很low
 不够准确 不够直观）

 ） 后台式采集：
 采集程序以守护进程运⾏在Linux后台，持续不断的采集数据： pormetheus
 exporter 例如

 python/go开发的daemon程序 后台持续不断的采集

 优点： 后台采集程序 数据准确性⾼ 采集密度精细 管理⽅便

 缺点：后台采集程序 如果开发过程不够仔细 可能会出现各种 内存泄漏
 僵⼫进程 性能瓶颈的问题， 且开 发周期较长

 ）桥接式采集： 本以后台进程运⾏ 但是采集不能独⽴ 依然跟服务器关联
 以桥接⽅式收集采集数据 例如：NRPE for nagios

 4 监控数据分析和算法

 例如： 采集CPU 的七种 等待状态参数 ， 采集户每秒访问请求量 QPS

 对于这些\"基本单位\"的数据采集 本是必须的 也是没有疑问的
 但是这有个问题

 采集回来的单位数据 如果没有懂⾏的⼈ 将它们形成 监控公式 和 报警阈值
 那采集数据就没有任何的意义了

 按上⾯两个例⼦来举例：

 CPU来举例

 CPU采集回来的 平均负载数值，以及CPU的时间⽚分布百分⽐ nagios top

 如果作为个运维架构师 不懂得 Linux中CPU各种参数的深⼊原理

 例如 平均负载是如何计算的，CPU的时间⽚分布是如何分类的，什么叫作
 户态/内核态 CPU等待/处理 时间 什么是 Interuptable/uniteruptable
 CPU等待

 等等这些概念。 那么即便数据被采集回来的再精细准确 你也利不好

 所以 这点我给家强调的是： 监控的数据分析和算法 其实⾮常依赖
 运维架构师对Linux操作系统的各 种底层知识的掌握 ， （这也是其中个
 我推荐prometheus的原因）

 如果 我们使那种⽼式的傻⽠式的监控 如nagios ，
 ⾯的监控脚本很全⾯(shell sh return, bin)，⽣成报警 规则 和
 阈值也很简单，缺点却显⽽易见： 监控的太粗糙 实性不强， 另外
 也不利于我们希望提⾼的同 学

 （例如：naigios 监控中 对CPU⾼不⾼的监控判断 就依据个 当前的load值
 \5 就警告 \10就报警， 我请 问这种⽅式的CPU报警 有什么意义么？
 有利于我们通过监控找到真正的问题么？）

 注：本阶段课程 主题是prometheus 我们可能没有过多的时间
 给家细讲Linux系统模型和内核参数 等等
 这些底层的优化知识，这些⾼级内容的具体学习 请参考
 ⽶运维课堂（系列课程） 第三第四阶段 的⾼ 级课程

 另外还有个问题

 例如业务级别监控的算法 运维⾃⽆法做到分专业
 因为本跟操作系统⽆关，是跟数据算法相关

 举个例⼦：如果我想通过Prometheus实现对户访问QPS的 精确监控

 那么对于 监控图形 曲线 QPS上涨
 QPS下跌，QPS凸起，QPS和历史数据的⽐较⽅法 等等这些 都属于业务
 级别的监控阈值类型

 需要有专业的数据分析⼈员的协助 才可以算出优良的算法

 例如： 如果我现在想针对 当前QPS下跌率进⾏报警计算， 那么什么养的公式
 针对我们的业务类型更贴 切？

 我是选择 计算当前5分钟内的平均值 当 \< 个固定数值的时候 报警合适？

 我是选择 计算当前10分钟的总量 然后和 前个⼩时同时段⽐较合适？

 我是选择 计算当前⼩时的平均值 和 过去周内
 每天的同时段的时间⽐较合适？

 。。。。

 艺体类推，这些数据算法 本跟Linux⽆关，只有⾮常专业的 数据计算团队
 才可以给出个最合理的算 法 协助我们的报警规则

 5 监控稳定测试

 不管是次性采集，还是后台采集，只要是在Linux上运⾏的东西
 都会多多少少对系统产⽣定的影响 稳定性测试
 就是通过段时间的单点部署观察 对线上有没有任何影响

 6监控⾃动化
 监控客户端的批量部署，监控服务端的HA再安装，监控项⽬的修改，监控项⽬的监控集群变化
 种种这些地⽅ 都需要量的⼈

 ⾃动化的引进 会很程度上 缩短我们对监控系统的维护成本

 这给出⼏个实例： Puppet（配置⽂件部署），Jenkins(CI 持续集成部署) ，
 CMDB（运维⾃动化的最⾼ 资源管理平台 和 理念 ）。。。。等等

 利好如上这⼏个聚的例⼦，就可以实现 对监控⾃动化的掌控

 （⾃动化具和编程 相关的学习 请参考 ⽶运维课堂 第 /
 三阶段的课程）

 7 监控图形化作

 采集的数据 和 准备好的监控算法，最终需要个好的图形展⽰
 才能发挥最好的作
 监控的设计搭建需要量的技术知识，但是对于个观察者来说（⽼板），往往不需要多少技术，只要
 能看懂图就好（例如 ⽼板想看看 当前户访问量状况，想看看 整体CPU⾼不⾼
 等等）

 所以 ， 监控的成图作 也是很重要的个内容

 本阶段课程中，会详细介绍个 很实的⾼上的图形集成具=》
 grafana的实和搭建 第讲内容结束，更多内容敬请关注

 第二讲 企业监控通用技术

 --- 第二讲内容

  介绍企业⽬前在监控上的发展阶段

  介绍企业当前实的通技术和具

  企业监控⽬前⾯临的些问题

  介绍监控的最终理想化

 **1 介绍企业⽬前在监控上的各个发展阶段 早期企业⽆监控** （路远靠⾛
 安全靠狗 \^\_\^）

 全部都是⼈盯着 服务器 操作系统 软件 ⽹络 等等

 **中前期企业 半⾃动脚本监控**
 利shell脚本这种类似的形式，做最简单的监控脚本 循环登陆机器
 查看些状态 之后⼈记录

 ⽆报警 ⽆⾃动化 ⽆监控图形

 **中期企业 ⾃动化程序/脚本/软件/监控**

 脚本更新换代 开始使各种开源⾮开源软件 程序 进⾏监控的搭建和开发
 监控形成图形化，加⼊报警系统 ，有定的监控本⾃动化实现
 这个阶段监控开始逐步成型 但是仍然缺乏精确度和稳定程度 报警的精细度

 **中后期企业 集群式监控 各种外援监控⽅案**

 监控开始⾃成体系 加⼊各种⾃动化

 除去⾃开发和搭建监控系统外，还会量使各种外围监控 （各种商品监控
 例如云计算监控 监控宝 友盟等等）

 监控发展出 内监控+ 外监控（内监控是企业⾃⼰搭建的⾃监控， 外监控是
 使外援的商业监控产品 往
 往对产品的最外层接⼜和户⾏为进⾏更宏观的监控）

 **当前和未来监控**

 根据⽬前的发展状况

 未来的监控 主要会在⼏个⽅⾯ 不断的提⾼

  监控准确性 真实性

  监控⾼度集成⾃动化 ⽆⼈值守

  监控成本的⽇益降低

  监控和CMDB的集成化以及⾃愈系统的发展

 2 **介绍企业当前实的通技术和具**

  脚本监控（当前依然使最原始的 脚本运⾏的形式 采集和监控的公司
 依然不在少数 很多时候是 为了节约成本）

  开源/⾮开源具监控 如：Nagios / Cacti / icinga / Zabbix / Ntop /
 prometheus / 等等。。

  报警系统 ： Pagerduty / ⾃建语⾳报警系统 / ⾃建邮件系统/
 ⾃建短信通知 / 各种商业报警产品

 3 **企业监控⽬前⾯临的些问题**

  监控⾃动化依然不够

  很少能和CMDB完善的结合起来

  监控依然需要量的⼈

  监控的准确性和真实性 提⾼的缓慢

  监控具和⽅案的制定 较为潦草

  对监控本的重视程度 依然有待提⾼ （其实是 最糟糕）

 **4 介绍监控的未来最终理想化**

 未来理想中最完美的监控 我这给出两个定义词汇

  完整⾃愈式监控体系

 监控和报警 总归还是只能发现问题。 出现问题之后的处理
 依然需要⼈的量⼲预 未来当⾃愈系统完善之后，各种层级的问题
 都会被各种⾃动化 持续集成 ⼈智能 灾备 系统缓冲 等等技 术⾃⾏修复

  真实链路式监控

 监控和报警的准确性 真实性 发展到最终级的个理想化模型

 举个例⼦： 当系统发出报警信息后，往往是各个层级的报警 堆起发出
 把真实引起问题的地⽅掩盖 住

 ⾮常不利于我们即时的发现和处理问题

 例如：真实发⽣的问题 是在于 数据库的个新的联合查询
 对系统资源消耗太 造成各个⽅⾯的资源被量消耗
 间接的就引起各种链路的问题

 于是乎 各个层⾯的报警 接踵⽽⾄， ⽇志在报警，慢查询在报警，数据库CPU
 内存报警， 程序层TCP链 接堆积报警，HTTP返回码5xx 499报警

 所有系统CPU 缓存报警， 企业级监控户流量下降报警

 种种堆堆被连带出来的报警 全都暴露出来了，结果真正的背后原因
 这个祸根的DB查询反⽽没有被 监控发现 或者说发现了 但是被彻底淹没了

 最终理想的未来报警系统 可以把所有⽆关的报警全部忽略掉，以链路的⽅式
 对问题查到底 把最终引 起问题的地⽅ 报警出来 让运维和开发
 即时做出响应和处理

 这就是未来的终极化监控报警系统的构想。 （这个理念 说起来容易
 实现起来⾮常难 需要量的 彻底的
 跟业务和代码结合起来，并且配合精密的前沿新算法
 以及所有运维开发的功能努 才有可能在未来的5-

 10年最终实现）

 第讲结束， 第三讲开始 我们正式开始prometheus的学习 敬请期待.
